<?xml version="1.0" encoding="UTF-8"?>

<!--
  ** @author gpothier
  -->
<project basedir="." default="all" name="StorySnipper">
	<description>
	  Build file for StorySnipper
  </description>

	<property file="conf/antbuild.properties" />

	<property name="dir.snipsnap-core" location="../snipsnap-core"/>
	<property name="dir.snipsnap.lib" location="${dir.snipsnap-core}/lib"/>
	<property name="dir.snipsnap.cls" location="${dir.snipsnap-core}/cls/default/WEB-INF/classes"/>

	<property name="dir.kafenio" location="../kafenio/kafenio-src_0_8_5"/>
	<property name="dir.kafenio.lib" location="${dir.kafenio}/dist"/>


	<property name="dir.base" location="."/>
	<property name="dir.build" location="${dir.base}/build"/>
	<property name="dir.out" location="${dir.base}/classes"/>
	<property name="dir.src" location="${dir.base}/src"/>
	<property name="dir.res" location="${dir.base}/resources"/>
	<property name="dir.conf" location="${dir.base}/conf"/>
	<property name="dir.lib.runtime" location="${dir.base}/lib/runtime"/>
	<property name="dir.lib.buildtime" location="${dir.base}/lib/buildtime"/>

	<path id="plugin.classpath">
		<pathelement location="${dir.snipsnap.cls}" />
		<pathelement location="${dir.snipsnap.lib}/commons-logging.jar" />
		<pathelement location="${dir.snipsnap.lib}/javax.servlet.jar" />
		<pathelement location="${dir.snipsnap.lib}/xmlrpc-1.2-b1.jar" />
		<pathelement location="${dir.snipsnap.lib}/dom4j.jar" />
		<pathelement location="${dir.snipsnap.lib}/gabriel.jar" />
		<pathelement location="${dir.snipsnap.lib}/radeox.jar" />
		<pathelement location="${dir.snipsnap.lib}/activation.jar" />

		<pathelement location="${dir.kafenio.lib}/kafenio.jar" />

		<pathelement location="${dir.lib.runtime}/zz.utils.jar" />
		<pathelement location="${dir.lib.runtime}/waltz.jar" />
		<pathelement location="${dir.lib.runtime}/foxtrot.jar" />
		<pathelement location="${dir.lib.runtime}/jibx-run.jar" />
		<pathelement location="${dir.lib.runtime}/xpp3.jar" />
		<pathelement location="${dir.lib.runtime}/commons-codec-1.3.jar" />
		<pathelement location="${dir.lib.runtime}/commons-httpclient-3.0-rc1.jar" />
		<pathelement location="${dir.lib.runtime}/metadata-extractor-2.2.2.jar" />

		<pathelement location="${dir.lib.buildtime}/jibx-bind.jar" />
		<pathelement location="${dir.lib.buildtime}/org.apache.jasper.jar" />

		<pathelement location="${dir.out}" />
	</path>

	<path id="classpath">
		<path refid="plugin.classpath" />
	</path>

	<!-- JiBX binding compiler task definition -->
	<taskdef name="bind" classname="org.jibx.binding.ant.CompileTask">
		<classpath>
			<pathelement location="${dir.lib.runtime}/jibx-run.jar" />
			<pathelement location="${dir.lib.runtime}/xpp3.jar"/>

			<pathelement location="${dir.lib.buildtime}/bcel.jar" />
			<pathelement location="${dir.lib.buildtime}/jibx-bind.jar"/>
			<pathelement location="${dir.lib.buildtime}/jibx-extras.jar"/>
		</classpath>
	</taskdef>



	<target name="prepare">
		<tstamp />
		<mkdir dir="${dir.build}" />
		<mkdir dir="${dir.out}" />
	</target>

	<target name="clean">
		<delete failonerror="false">
			<fileset dir="${dir.build}"/>
			<fileset dir="${dir.out}"/>
		</delete>
	</target>

	<target name="compile" depends="prepare">
		<javac srcdir="${dir.src}" destdir="${dir.out}" classpathref="classpath" debug="yes" />
	</target>

	<!-- Run JiBX binding compiler -->
	<target name="jibx" >
		<bind verbose="false" load="true">
			<bindingfileset dir="${dir.src}">
				<include name="bindings.xml"/>
			</bindingfileset>

			<classpath refid="classpath"/>
		</bind>
	</target>

	<target name="compile-jsp" depends="prepare">
		<jspc destdir="${dir.src}" srcdir="${dir.src}"
			package="zz.snipsnap.plugin.media"
			classpathref="plugin.classpath">
			
			<include name="**/*.jsp"/>
		</jspc>
	</target>

	<target name="compile-plugins" depends="prepare">
		<javac srcdir="${dir.src}" destdir="${dir.out}" 
			classpathref="classpath" debug="yes">

			<include name="zz/snipsnap/plugin/**"/>
			<include name="zz/snipsnap/utils/**"/>
			<include name="zz/snipsnap/client/core/AttachmentDescriptor.java"/>
			<exclude name="zz/snipsnap/plugin/media/showmedia.java"/>
		</javac>
	</target>

	<target name="compile-macros" depends="prepare">
		<javac srcdir="${dir.src}" destdir="${dir.out}" 
			classpathref="classpath" debug="yes">

			<include name="zz/snipsnap/macro/**"/>
			<include name="zz/snipsnap/utils/**"/>
			<include name="zz/snipsnap/client/core/AttachmentDescriptor.java"/>
		</javac>
	</target>

	<target name="jar-kit" depends="clean, compile-plugins, compile-macros, jibx">
		<jar destfile="${dir.build}/stsn-kit.jar" excludes="**/.svn">
			<fileset dir="${dir.out}/">
				<include name="zz/snipsnap/plugin/**"/>
				<include name="zz/snipsnap/macro/**"/>
				<include name="zz/snipsnap/utils/**"/>
				<include name="zz/snipsnap/utils/**"/>
				<include name="zz/snipsnap/storysnipper/Resources.class"/>
			</fileset>

			<fileset dir="${dir.res}">
				<include name="**"/>
			</fileset>
			
			<fileset dir="${dir.conf}" includes="**" />
		</jar>
	</target>

	<target name="jar-storysnipper" depends="clean, compile, jibx">
		<jar destfile="${dir.build}/storysnipper.jar" excludes="**/.svn">
			<fileset dir="${dir.out}/">
				<include name="zz/snipsnap/**"/>
			</fileset>
			
			<fileset dir="${dir.res}">
				<include name="**"/>
			</fileset>

			<manifest>

				<attribute 
					name="Class-Path" 
					value="activation.jar commons-codec-1.3.jar commons-httpclient-3.0-rc1.jar commons-logging.jar foxtrot.jar javax.servlet.jar jibx-run.jar kafenio-config.jar kafenio-icons.jar kafenio.jar metadata-extractor-2.2.2.jar waltz.jar xmlrpc-1.2-b1.jar xpp3.jar zz.utils.jar"/>

				<attribute name="Main-Class" value="zz.snipsnap.storysnipper.StorySnipper"/>

			</manifest>
		</jar>
	</target>

	<target name="all" depends="jar-kit, jar-storysnipper"/>

</project>

